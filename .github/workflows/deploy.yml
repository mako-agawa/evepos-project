name: CI/CD Deploy to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    env:
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}

    steps:
      # 1ï¸âƒ£ GitHubãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ EC2ã¸ã®SSHæ¥ç¶šã¨ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 60m
          script: |
            set -x  # è©³ç´°ãƒ­ã‚°ã®æœ‰åŠ¹åŒ–
            echo "ğŸ‰ Starting deployment..."

            # PATHã®è¨­å®š
            source ~/.bashrc
            export PATH="$PATH:$HOME/.rbenv/shims:$HOME/.rbenv/bin"
            eval "$(rbenv init -)"
            
            # 1ï¸âƒ£ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•
            cd /home/ec2-user/evepos-project/event-post-api
            echo "ğŸ“ Changed directory to /home/ec2-user/evepos-project/event-post-api"

            # 2ï¸âƒ£ ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°
            git reset --hard HEAD
            echo "ğŸ”„ Code reset complete"
            git pull origin main
            echo "ğŸ”„ Code updated to latest version"

            # 3ï¸âƒ£ Bundlerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            bundle config set without 'development test'
            echo "ğŸ“¦ Installing gems..."
            bundle install --quiet
            echo "âœ… Gems installed successfully"

            # 4ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            echo "ğŸ“… Running database migrations..."
            RAILS_ENV=production bundle exec rake db:migrate
            echo "âœ… Migrations complete"

            # 5ï¸âƒ£ Pumaã®åœæ­¢
            echo "ğŸ›‘ Stopping existing Puma process..."
            if [ -f /home/ec2-user/evepos-project/event-post-api/tmp/pids/puma.pid ]; then
              kill -QUIT $(cat /home/ec2-user/evepos-project/event-post-api/tmp/pids/puma.pid)
              sleep 5
            else
              pkill -9 -f 'puma.*production' || echo "No running Puma process found."
              sleep 5
            fi
            echo "âœ… Puma process stopped"

            # 6ï¸âƒ£ Pumaã®èµ·å‹•
            echo "ğŸš€ Starting Puma server..."
            RAILS_ENV=production bundle exec puma -C config/puma.rb --daemon || echo "Puma failed to start"
            tail -n 20 log/production.log  # Pumaèµ·å‹•å¾Œã®ãƒ­ã‚°ã‚’ç¢ºèª
            echo "âœ… Puma started successfully"

            # 7ï¸âƒ£ Nginxã®å†èµ·å‹•
            echo "ğŸ”„ Restarting Nginx..."
            sudo systemctl restart nginx || echo "Failed to restart Nginx"
            echo "âœ… Nginx restarted successfully"

            echo "ğŸš€ Deployment complete"
