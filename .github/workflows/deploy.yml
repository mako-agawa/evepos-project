name: CI/CD Deploy to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Cache gems
        uses: actions/cache@v3
        with:
          path: ~/.bundle
          key: ${{ runner.os }}-gemfile-${{ hashFiles('**/Gemfile.lock') }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.4'

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 40m
          script: |
            export PATH="$PATH:$HOME/.rbenv/shims:$HOME/.rbenv/bin"
            eval "$(rbenv init -)"

            cd /home/***/evepos-project/event-post-api

            git reset --hard HEAD
            git pull origin main

            bundle config set without 'development test'
            bundle install

            RAILS_ENV=production bundle exec rake db:migrate

            if pgrep -f 'unicorn.*production' > /dev/null; then
              pkill -f 'unicorn.*production'
            fi

            RAILS_ENV=production bundle exec unicorn -c config/unicorn.rb -E production -D

            sudo systemctl restart nginx
