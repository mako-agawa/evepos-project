name: CI/CD Deploy to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    env:  # ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’ä¿®æ­£ (2ã‚¹ãƒšãƒ¼ã‚¹)
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}  # ã“ã“ã§RAILS_MASTER_KEYã‚’è¨­å®š

    steps:
      # 1ï¸âƒ£ GitHubãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ EC2ã¸ã®SSHæ¥ç¶šã¨ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 60m
          script: |
            echo "ğŸ‰ Starting deployment..."

            # PATHã®è¨­å®š
            source ~/.bashrc
            export PATH="$PATH:$HOME/.rbenv/shims:$HOME/.rbenv/bin"
            eval "$(rbenv init -)"
            
            # 1ï¸âƒ£ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•
            cd /home/ec2-user/evepos-project/event-post-api
            echo "ğŸ“ Changed directory to /home/ec2-user/evepos-project/event-post-api"

            # 2ï¸âƒ£ ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°
            git reset --hard HEAD
            echo "ğŸ”„ Code reset complete"
            git pull origin main
            echo "ğŸ”„ Code updated to latest version"

            # 3ï¸âƒ£ Bundlerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            bundle config set without 'development test'
            echo "ğŸ“¦ Installing gems..."
            bundle install --quiet
            echo "âœ… Gems installed successfully"

            # 4ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            echo "ğŸ“… Running database migrations..."
            RAILS_ENV=production bundle exec rake db:migrate
            echo "âœ… Migrations complete"

            # 5ï¸âƒ£ Unicornã®åœæ­¢
            echo "ğŸ›‘ Stopping existing Unicorn process..."
            if [ -f /home/ec2-user/evepos-project/event-post-api/tmp/pids/unicorn.pid ]; then
              kill -QUIT $(cat /home/ec2-user/evepos-project/event-post-api/tmp/pids/unicorn.pid)
              sleep 5
            else
              if pgrep -f 'unicorn.*production' > /dev/null; then
                pkill -f 'unicorn.*production'
                sleep 5
              fi
            fi
            echo "âœ… Unicorn process stopped"

            # 6ï¸âƒ£ Unicornã®èµ·å‹•
            echo "ğŸš€ Starting Unicorn server..."
            nohup RAILS_ENV=production bundle exec unicorn -c config/unicorn.rb -E production -D > unicorn.log 2>&1 &
            echo "âœ… Unicorn started successfully"

            # 7ï¸âƒ£ Nginxã®å†èµ·å‹•
            echo "ğŸ”„ Restarting Nginx..."
            sudo systemctl restart nginx
            echo "âœ… Nginx restarted successfully"
